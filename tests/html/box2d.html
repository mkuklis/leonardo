<html>
  <head></head>
  <body>
    <script src="../lib/Box2dWeb-2.1.a.3.min.js"></script>
    <script src="../../src/leonardo.js"></script>
    <script src="../../src/matrix.js"></script>
    <script src="../../src/color.js"></script>
    <script src="../../src/element.js"></script>
    <script src="../../src/pubsub.js"></script>
    <script src="../../src/event.js"></script>
    <script src="../../src/polyfill.js"></script>
    <script src="../../src/easings.js"></script>
    <script src="../../src/animation.js"></script>
    <script>

      var paper = new Leonardo(0, 0, 1200, 500);

      var b2Vec2 = Box2D.Common.Math.b2Vec2
        , b2BodyDef = Box2D.Dynamics.b2BodyDef
        , b2Body = Box2D.Dynamics.b2Body
        , b2FixtureDef = Box2D.Dynamics.b2FixtureDef
        , b2Fixture = Box2D.Dynamics.b2Fixture
        , b2World = Box2D.Dynamics.b2World
        , b2MassData = Box2D.Collision.Shapes.b2MassData
        , b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
        , b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
        , b2DebugDraw = Box2D.Dynamics.b2DebugDraw

        , world = new b2World(new b2Vec2(0, 10), true)
        , SCALE = 30

        , fixDef = new b2FixtureDef()
        , bodyDef = new b2BodyDef();

      fixDef.density = 1.0;
      fixDef.friction = 0.5;
      fixDef.restitution = 0.2;

      bodyDef.type = b2Body.b2_staticBody;
      bodyDef.position.x = paper.canvas.width / 2 / SCALE;
      bodyDef.position.y = paper.canvas.height / SCALE;
      // floor
      fixDef.shape = new b2PolygonShape()
      fixDef.shape.SetAsBox((paper.canvas.width / SCALE) / 2, (10/SCALE) / 2);
      world.CreateBody(bodyDef).CreateFixture(fixDef);
      var rect = paper.rect(0,  paper.canvas.height  - 5, paper.canvas.width, 5);
      rect.attr({fill: "#00ff00"});

      // objects

      bodyDef.type =  b2Body.b2_dynamicBody;
      var circles = [];
      for (var i = 0; i < 100; i++) {
        var r = Math.random() + 0.1
          , x = Math.random() * 25
          , y = Math.random() * 10;

        fixDef.shape = new b2CircleShape(r);
        bodyDef.position.x = x;
        bodyDef.position.y = y;
        var body = world.CreateBody(bodyDef).CreateFixture(fixDef);
        var circle = paper.circle(x * SCALE, y * SCALE, r * SCALE, {fill: "#ff0000"});
        circle.attr({body: body}, {silent: true});
        circles.push(circle);
      }

      function redraw(el) {
        var body = el.attr('body');
        if (body) {
          el.attr({x: body.m_body.GetPosition().x * SCALE, y: body.m_body.GetPosition().y * SCALE}, {silent: true});
        }
      }

      function update() {
        world.Step(1 / 60, 10, 10);
        paper.redraw(redraw);
        world.ClearForces();
        requestAnimationFrame(update);
      };

      //setTimeout(function () {
        update();
      //}, 2000);

    </script>
  </body>
</html>
